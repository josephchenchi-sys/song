# 功能規格書：影片去人聲 (Video Vocal Remover)

**功能分支**: `001-video-vocal-remover`  
**建立日期**: 2025-12-25  
**狀態**: 草稿 (Draft)  
**輸入**: 使用者描述: "我想要寫一個把我上傳的影片去人聲的一個純前端網站，使用ffmpeg.wasm 0.11.6以及https://www.npmjs.com/package/demucs-web"
**更新輸入**: "我想要有一個預覽，可以當卡拉OK的介面，然後可以開關導唱、升降key"

## 釐清事項 (Clarifications)

### Session 2025-12-25
- Q: 下載檔案是否套用升降 Key 設定？ → A: **Option B (套用至下載)**。下載的影片必須套用使用者在預覽介面設定的音調變更（所聽即所得）。
- Q: 預覽模式的預設導唱狀態？ → A: **Option A (預設開啟/原曲)**。進入預覽模式時，預設播放完整原曲（人聲+伴奏），使用者需手動關閉導唱。
- Q: 檔案大小限制？ → A: **Option A (無限制/盡力而為)**。不設定硬性檔案大小上限，允許使用者嘗試處理任何檔案，但系統需在記憶體不足 (OOM) 時提供清楚的錯誤提示。
- Q: 行動裝置支援度？ → A: **Option A (桌面優先)**。系統將針對桌面環境最佳化。若偵測到行動裝置，應顯示「建議使用電腦」的提示，但不強制封鎖。

## 使用者情境與測試 *(Mandatory)*

### 使用者故事 1 - 處理影片並下載 (優先級: P1)

作為一個使用者，我想要上傳一個影片檔並下載已去除人聲的處理版本，這樣我就能獲得該影片的純伴奏版本，而無需使用複雜的軟體。

**優先級理由**: 這是核心價值主張。沒有這個功能，此工具就沒有存在的意義。

**獨立測試**: 上傳一個含有音樂與人聲的範例影片，等待處理完成，下載結果，並驗證下載的影片播放時僅有伴奏音訊。

**驗收情境**:

1. **Given** 應用程式已載入，**When** 我選擇一個包含人聲音樂的影片檔（例如 MP4），**Then** 系統應接受該檔案並開始處理。
2. **Given** 處理已完成，且未調整音調，**When** 我點擊「下載」按鈕，**Then** 影片檔應儲存至我的裝置，內容為原調伴奏。
3. **Given** 已下載的處理後影片，**When** 我播放它，**Then** 我應聽到與原始影片同步的純伴奏音軌（已去除人聲）。
4. **Given** 我在預覽模式調整了音調（例如升 2 Key），**When** 我點擊「下載」按鈕，**Then** 下載的影片音軌必須是升 2 Key 之後的版本。

---

### 使用者故事 2 - 處理進度回饋 (優先級: P2)

作為一個使用者，我想要在影片處理期間看到進度指示，這樣我就能知道應用程式在執行耗時操作時並未當機。

**優先級理由**: 瀏覽器內的影片處理 (WASM) 極耗資源且費時。缺乏回饋會導致使用者放棄等待。

**獨立測試**: 上傳一個較大的影片，並在處理階段觀察使用者介面。

**驗收情境**:

1. **Given** 影片正在處理中，**When** 操作進行時，**Then** 進度條或百分比指示器應更新以反映當前狀態。
2. **Given** 處理已完成，**When** 指示器達到 100%，**Then** 介面應轉換至「完成/下載」狀態。

---

### 使用者故事 3 - 卡拉 OK 預覽模式 (優先級: P3)

作為一個使用者，我想要在瀏覽器中進入「卡拉 OK 模式」進行預覽，我能夠隨時開關原唱（導唱）並調整音調（升降 Key），以便於我在下載前進行練唱或確認伴奏效果。

**優先級理由**: 提升使用者體驗，讓工具不僅是「處理器」，更是即時的「練唱工具」。

**獨立測試**: 處理完影片後，進入預覽介面，操作導唱開關與升降 Key 按鈕，確認聽覺變化。

**驗收情境**:

1. **Given** 進入預覽模式，**When** 預覽開始播放，**Then** 預設應聽到完整原曲（人聲+伴奏）。
2. **Given** 進入預覽模式，**When** 我點擊「關閉導唱」，**Then** 影片的人聲部分應消失，僅保留伴奏。
3. **Given** 預覽正在播放，**When** 我點擊「升 Key」或「降 Key」按鈕，**Then** 影片的音樂音高應即時改變，但播放速度保持不變。
4. **Given** 已調整過 Key，**When** 我切換導唱開關，**Then** 人聲與伴奏的音高應保持同步（同樣的升降 Key 設定）。

### 邊界案例 (Edge Cases)

- 當使用者上傳非影片檔案時會發生什麼？
- 系統如何處理可能導致瀏覽器分頁崩潰的超大檔案？（**更新**: 採盡力而為策略，若崩潰需顯示錯誤，但不預先阻擋）
- 如果瀏覽器不支援所需的 WebAssembly 功能會發生什麼？
- 如果影片沒有音軌會發生什麼？
- 升降 Key 超過一定範圍（例如 +/- 12 半音）時，音質是否會嚴重劣化或系統限制？
- 當使用者使用手機瀏覽器訪問時，效能不足導致體驗不佳？（**更新**: 顯示建議使用桌面版提示）

## 需求 *(Mandatory)*

### 功能需求 (Functional Requirements)

- **FR-001**: 系統必須允許使用者從本機裝置選擇影片檔案。
- **FR-002**: 系統必須完全在瀏覽器內（客戶端）處理影片檔案，無需上傳至遠端伺服器。
- **FR-003**: 系統必須將影片音訊中的人聲軌與伴奏軌分離。
- **FR-004**: 系統必須將原始視訊流與分離出的伴奏音訊流結合。
- **FR-005**: 系統必須提供下載最終處理後影片檔的機制。若使用者有調整音調，下載的檔案必須套用該音調設定。
- **FR-006**: 系統必須支援常見的網頁相容影片格式（例如 MP4, WebM）。
- **FR-007**: 如果處理失敗（例如記憶體不足），系統必須顯示使用者友善的錯誤訊息。
- **FR-008**: 系統必須提供預覽播放介面，允許使用者獨立控制「人聲軌」的靜音/取消靜音（導唱開關）。
- **FR-009**: 系統必須在預覽播放介面提供「升降 Key」功能，能即時調整音高而不改變播放速度。
- **FR-010**: 進入預覽模式時，導唱（人聲軌）預設必須為**開啟**狀態。
- **FR-011**: 系統不應設定硬性的影片大小上限，但在記憶體耗盡導致處理失敗時，必須提供清楚的錯誤提示。
- **FR-012**: 當偵測到使用者使用行動裝置（手機/平板）時，系統應顯示提示訊息，建議使用桌面瀏覽器以獲得最佳效能，但不應強制阻止使用者操作。

### 關鍵實體 (Key Entities)

- **來源影片 (Source Video)**: 使用者提供的原始檔案。
- **分離軌道 (Separated Tracks)**: 分離出的「純人聲」與「純伴奏」音軌。
- **播放設定 (Playback Settings)**: 包含目前的 Key 偏移量 (Pitch Shift) 與導唱狀態 (Vocal Toggle)。

## 成功標準 *(Mandatory)*

### 可測量成果 (Measurable Outcomes)

- **SC-001**: 使用者可以在標準筆記型電腦上成功處理 1 分鐘的影片檔 (720p)，且瀏覽器不會崩潰。
- **SC-002**: 產生的影片檔不包含明顯的人聲頻率（經人類聽覺驗證），同時保留伴奏的清晰度。
- **SC-003**: 100% 的影片處理發生在本地（可透過網路檢查驗證無影片上傳行為）。
- **SC-004**: 輸出影片的長度與輸入影片長度的誤差在 1 秒以內。
- **SC-005**: 在預覽模式下，切換導唱的延遲時間應小於 200ms。
- **SC-006**: 升降 Key 功能應支援至少 +/- 6 個半音的調整範圍。